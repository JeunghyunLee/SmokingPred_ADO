---
title: "Time-lagged prediction for daily cigarette usage"
author:
  - Jeung-Hyun Lee
date: "`r Sys.Date()`"
output: 
  pdf_document: 
    number_sections: yes
    latex_engine: xelatex
    keep_tex: yes
editor_options:
  chunk_output_type: console
header-includes:
- \usepackage{kotex}
- \usepackage{float}
- \usepackage{booktabs}
- \usepackage{colortbl}
- \usepackage{makecell}
- \usepackage{pdflscape}
- \newcommand{\blandscape}{\begin{landscape}}
- \newcommand{\elandscape}{\end{landscape}}
---

```{r setup, include=FALSE}
# Reset workspace
rm(list = ls())
setwd("~/Github/smoking_ado")

# For plotting
library(tidyverse)
library(lubridate)
library(cowplot)
library(latex2exp)

# For summary and tables
library(gtsummary)
library(kableExtra)

# For modeling
library(lme4)
library(lmerTest)
library(glmnet)
library(MuMIn)
library(rsq)
library(r2glmm)
library(splitTools)
library(corrplot)

library(ggcorrplot)
library(Hmisc)

knitr::opts_chunk$set(
  echo = FALSE, message = FALSE, warning = FALSE,
  fig.align = 'center', dpi = 300, out.width = '\\textwidth')
```

```{r globals}
FILE_DATA <- file.path('.', 'data')

MAP_LABEL_SURVEY <- list(
  "Q51"   = "has_used_cigar",
  "Q52"   = "has_used_ecigar",
  "Q1"    = "Usage",
  "Q1p"   = "Usage",
  "lgQ1p" = "Log usage",
  "Q53"   = "usage_ecigar",
  "Q2"    = "Craving",
  "Q3"    = "Mood",
  "Q4"    = "sleep_problem",
  "Q5"    = "troubles_with_family_friends",
  "Q6"    = "Stress",
  "Q7"    = "Depression",
  "Q8"    = "Anxiety",
  "Q9"    = "hobby",
  "Q10"   = "time_with_family_friends",
  "Q11"   = "religion",
  "Q30"   = "Medication"
  # "Q31"   = "medication_varenicline",
  # "Q32"   = "medication_bupropion",
  # "Q33"   = "medication_nicotine patches",
  # "Q34"   = "medication_gum",
  # "Q35"   = "medication_candy"
)

COLS_IV_DEMO <- c('age', 'sex', 'dur_smoking')
LABELS_DEMO <- list(
  age = 'Age',
  sex = 'Sex (Female)',
  sexFemale = 'Sex (Female)',
  dur_smoking = 'Smoking duration'
)
LABELS_DV <- list(
  daily_avg_cat_base = 'Cigarette usage (Screening)',
  daily_avg_cat_pre = 'Cigarette usage (Pre-clinic)',
  daily_avg_cat_post = 'Cigarette usage (Post-clinic)',
  usage_reduced_12 = 'Cig usage reduced (Screening -- Pre-clinic)',
  usage_reduced_13 = 'Cig usage reduced (Screening -- Post-clinic)',
  usage_reduced_23 = 'Cig usage reduced (Pre-clinic -- Post-clinic)'
  # usage_reduced_23 = 'Success to reduce\ncigarette usage'
)

LABELS_SMOKING_AVG <- c(
  'y = 0',
  '0 < y <= 5',
  '5 < y <= 10',
  # '10 < y <= 20',
  '10 < y'
  # 'y > 20'
)
LABELS_SMOKING_QUIT <- c(
  'Quit',
  'Non-quit'
)
MAP_LABEL_PARAM <- list(
  alpha = '$\\alpha$',
  beta = '$-\\beta$',
  logk = 'log k'
)

MAP_LABEL_DEMO <- list(
  age = 'Age',
  sex = 'Sex',
  sexFemale = 'Sex (Female)',
  day = 'Day',
  subject = 'Subject'
)

MAP_LABEL <- c(MAP_LABEL_SURVEY, MAP_LABEL_PARAM, MAP_LABEL_DEMO)

# IV_SURVEY <- c('Q1', 'Q2', 'Q3', 'Q6', 'Q7', 'Q8')
IV_SURVEY <- c('Q1', 'Q2', 'Q3', 'Q6', 'Q7', 'Q8', 'Q30') # Q30 - medication
IV_PARAM <- c('alpha', 'beta', 'logk')
IV_DEMO <- c('age', 'sex')

CRIT_DAYS = 14
```

```{r load_data}
df_daily <- 
  read_tsv(FILE_DATA, 'a1_daily.tsv', show_col_types = FALSE)

### Quit criteria 
## did_not_smoke_last_week_co
  # 1) mri2 survey: did not smoke last week 
  # 2) app survey: 0 smoke last week's mean response
  # 3) mri2 CO: ppm <5ppm 
## did_not_smoke_last_month_co
  # 1) mri2 survey: did not smoke last month
  # 2) app survey: 0 smoke last month's mean response
  # 3) mri2 CO: ppm <5ppm 
## usage_reduced
  # 1) mri2 -> mri1 usage reduced
FILE_CHEM <- file.path(PATH_REPO_DATA, 'chemical_tests_n121.csv')
FILE_QUIT <- file.path(PATH_REPO_DATA, 'quit_n113.csv')
FILE_APP_QUIT <- file.path(PATH_DATA, 'app-smoking_quit.tsv')

df_chemical <- 
  read_csv(FILE_CHEM, show_col_types = FALSE)

df_quit <- 
  read_csv(FILE_QUIT, show_col_types = FALSE) %>% 
  full_join(read_tsv(FILE_APP_QUIT, show_col_types = FALSE),
            by = 'subject')

df_quit_crit <- 
  df_quit %>% 
    left_join(df_chemical %>% 
                dplyr::select(subjID, CO_ppm_mri2) %>% 
                rename(subject = subjID), by = 'subject') %>% 
    mutate(did_not_smoke_last_week_co = ifelse(# did_not_smoke_last_week == 1 & 
                                                 CO_ppm_mri2 <5 & 
                                                 last_week_quit == 1, 1, 0),
           did_not_smoke_last_month_co = ifelse(# did_not_smoke_last_month == 1 &
                                                  CO_ppm_mri2 < 5 &
                                                  last_month_quit == 1, 1, 0)) %>% 
  dplyr::select(subject, last_week_quit, last_month_quit, 
         did_not_smoke_last_week_co, did_not_smoke_last_month_co) 

# Daily survey data (raw) For analysis 2
df_survey_raw <-
  read_tsv('./repo_data/app-survey_all.tsv', show_col_types = FALSE) 
  # filter(day <= 14)

# Daily app task data (raw) For analysis 2
df_param_raw <-
  read_tsv('./data/param_est_exc_full.tsv', show_col_types = FALSE)
  # filter(day <= 14)


```

```{r functions}
make_formula <- function(dv, ivs_fixed, ivs_random = NULL) {
  eqn <- str_c(dv, ' ~ ')
  
  if (is.null(ivs_fixed)) {
    eqn <- str_c(eqn, '1')
  } else {
    eqn <- str_c(eqn, paste(ivs_fixed, collapse = ' + '))
  }
  
  if (!is.null(ivs_random)) {
    eqn <- str_c(
      eqn, ' + ',
      paste(str_c('(1 | ', ivs_random, ')'), collapse = ' + ')
    )
  }
  
  as.formula(eqn)
}

get_r2_marg_cond <- function(mod) {
  if (any(class(mod) == 'lm')) {
    return(list(marg = rsq(mod), cond = rsq(mod)))
  }
  
  # Zhang, D. (2020). Coefficients of determination for mixed-effects models. arXiv:2007.0867.
  fit <- rsq::rsq(mod)
  list(marg = fit$fixed, cond = fit$model)
  
  # Nakagawa, S., Schielzeth, H. (2013) A general and simple method for obtaining R² from Generalized Linear Mixed-effects Models. Methods in Ecology and Evolution 4: 133–142
  # fit <- r.squaredGLMM(mod)
  # list(marg = fit[1], cond = fit[2])
}

run_model <- function(data, config) {
  fml <- make_formula(config$dv, config$ivs_fixed, config$ivs_random)
  
  is_glm <- (config$model_name %in% c('GLM', 'GLMM'))
  model_func <- switch(
    config$model_name, LM = lm, GLM = glm, LMM = lmer, GLMM = glmer)
  
  if (!is_glm) {
    mod <- model_func(formula = fml, data = data)
  } else {
    mod <- model_func(formula = fml, data = data, family = config$model_family)
  }
  
  if (config$exclude_outliers) {
    model_subset <- cooks.distance(mod) < (4 / nrow(data))
    data_subset <- data[model_subset,]
    
    if (!is_mod_glm) {
      mod <- model_func(formula = fml, data = data_subset)
    } else {
      mod <- model_func(formula = fml, data = data_subset, family = config$model_family)
    }
    
    return(list(data = data_subset, fml = fml, mod = mod))
  }
  
  return(list(data = data, fml = fml, mod = mod))
}

get_label_for_term <- function(term) {
  tt <- term %>% str_remove('_next') %>% str_remove('_curr')
  ret <- MAP_LABEL[tt] %>% unlist %>% unname
  ret
}

get_label_for_term_wo <- function(term) {
  tt <- term %>% str_remove('_curr')
  ret <- MAP_LABEL[tt] %>% unlist %>% unname
  ret
}

calculate_r2 <- function (y, y_hat) {
  1 - sum((y - y_hat) ** 2, na.rm = TRUE) / sum((y - mean(y, na.rm = TRUE)) ** 2, na.rm = TRUE)
}

calculate_mse <- function (y, y_hat) {
  mean((y - y_hat) ** 2)
}

# here
draw_coef_figure <- function(mod, title = NULL, custom_order=NULL) {
  smr <- summary(mod)
  subtitle <- NA
  if (any(class(mod) == 'glm')) {
    r2 <- MuMIn::r.squaredGLMM(mod)
    subtitle <- 
      sprintf("$R^2$ = $%.3f$", r2[1]) %>%
      TeX()
  } else if (class(mod) == 'lm') {
    subtitle <- 
      sprintf("$R^2$ = $%.3f$, Adjusted $R^2$ = $%.3f$",
              smr$r.squared, smr$adj.r.squared) %>%
      TeX()
  } else {
    r2 <- get_r2_marg_cond(mod)
    subtitle <-
      sprintf("$R^2_{fixed}$ = $%.3f$, $R^2_{total}$ = $%.3f$",
              r2$marg, r2$cond) %>%
      TeX()
  }
  
  df_coef <-
    smr$coefficients %>%
    as.data.frame() %>%
    rownames_to_column('term') %>%
    as_tibble() %>%
    rename(estimate = Estimate,
           std.error = `Std. Error`) %>%
    rename_at(vars(starts_with('Pr(>')), function(v) 'p.value') %>%
    filter(term != '(Intercept)') %>%
    mutate(
      term = factor(
        term,
        levels = if (!is.null(custom_order)) custom_order else term %>% rev,
        labels = if (!is.null(custom_order)) custom_order else get_label_for_term(term) %>% rev
      ),
      ci_lower = estimate - 1.96 * std.error,
      ci_upper = estimate + 1.96 * std.error,
      is_sig = ifelse(ci_lower > 0, 1, ifelse(ci_upper < 0, -1, 0)),
      is_sig = as.character(is_sig)
    )
  
  p_coef <-
    df_coef %>%
    ggplot(aes(x = term, y = estimate, color = is_sig)) +
    geom_hline(yintercept = 0, colour = "grey60", linetype = 2) +
    geom_errorbar(aes(ymin = ci_lower, ymax = ci_upper), width = 0) +
    geom_point(size = 3) +
    labs(y = "Beta estimate",
         title = title, 
         subtitle = subtitle) +
    scale_color_manual(values = c("1" = "red", "0" = "#666666", "-1" = "blue")) +
    # scale_x_discrete(labels = TeX(as.character(df_coef$term))) +
    coord_flip() +
    theme_bw() +
    theme(legend.position = "none",
          axis.title.y = element_blank(),
          axis.text.y = element_text(size = 11, hjust = 1, color = 'black'),
          plot.title = element_text(face = "bold", hjust = 0.5),
          plot.subtitle = element_text(hjust = 0.5))
  
  p_coef
}

draw_figure <- function(data, config, mod, y_label, title) {
  smr <- summary(mod)
  
  is_lmm <- !any(class(mod) == 'lm')
  
  y_pred <- predict(mod, newdata = data, type = 'response', allow.new.levels = TRUE)
  if (!is_lmm) {
    y_link <- y_pred
  } else {
    y_link <- predict(mod, newdata = data, type = 'link', allow.new.levels = TRUE)
  }
  y_true <- data %>% pull(!!as.name(y_label))
  y_resi <- scale(y_true - y_pred) %>% unname %>% as.vector()
  
  custom_order <- c(# "sexFemale", "age", 
                  "alpha_curr", "beta_curr", "logk_curr", 
                  "Q2_curr", "Q3_curr", "Q6_curr", "Q8_curr", 
                  "Q7_curr", "Q1_curr", "Q30_curr", "day", "(Intercept)")
  
  dat_fixed <- 
    data %>%
      dplyr::select(all_of(config$ivs_fixed)) %>%
      mutate(`(Intercept)` = 1) %>%
      select(all_of(custom_order)) %>% 
      # dplyr::select(`(Intercept)`, everything()) %>% 
      as.matrix
  
  coef_fixed <-
    smr$coefficient %>%
    as.data.frame() %>%
    rownames_to_column('variable') %>%
    dplyr::select(variable, Estimate) %>%
    mutate(variable = factor(variable, levels = custom_order)) %>%
    arrange(variable) %>% 
    column_to_rownames('variable') %>% 
    as.matrix# as.vector
  
  y_fixed <-
    config$model_family$linkinv(dat_fixed %*% as.matrix(coef_fixed)) %>%
    unname %>%
    as.vector
  
  df_pred <-
    data %>%
    mutate(y_pred = y_pred,
           y_true = !!as.name(y_label),
           y_link = y_link,
           y_pred_fixed = y_fixed,
           y_resi = y_resi) %>%
    dplyr::select(subject, day_orig, y_pred, y_pred_fixed, y_true, y_link, y_resi)
  
  
  p_coef <-
    draw_coef_figure(mod, '', custom_order) +
    theme(plot.title = element_blank())
  
  p_pred_day <-
    df_pred %>%
    # filter(subject %in% c("SMO21302")) %>% 
    # filter(subject %in% c("SMO19509", "SMO19301", "SMO19306", "SMO22104", "SMO22208",
    #                       "SMO22209", "SMO22201", "SMO22302", "SMO21402", "SMO22506")) %>%  # var
    filter(subject %in% c("SMO19403", "SMO19407", "SMO19408", "SMO19412", "SMO21104",
                          "SMO21303", "SMO21302", "SMO22408", "SMO22401", "SMO22307")) %>%  # stab
    dplyr::select(day_orig, y_pred, y_true, y_pred_fixed) %>%
    (function(ddd) {
      if (!is_lmm) {
        return(ddd %>% dplyr::select(-c(y_pred_fixed)))
      }
      
      ddd
    }) %>%
    gather(variable, value, -day_orig) %>%
    group_by(day_orig, variable) %>%
    mutate(value = mean(value),
           se = sd(value) / sqrt(n() - 1)) %>%
    ggplot(aes(x = day_orig, y = value, color = variable)) +
    geom_line(aes(color = variable, linetype = variable)) +
    # geom_point(aes(color = variable)) +
    # coord_cartesian(ylim = c(0, NA)) +
    coord_cartesian(ylim = c(0, 12)) +
    scale_color_manual(
      values = c(y_pred = '#D1495B', y_pred_fixed = '#66A182', y_true = '#8D96A3'),
      labels = TeX(c(
        y_pred = '$Y_{pred}$',
        y_pred_fixed = '$Y_{pred}^{(fixed)}$',
        y_true = '$Y_{true}$'
      )),
      drop = TRUE
    ) +
    scale_linetype_manual(
      values = c(y_pred = 'solid', y_pred_fixed = 'solid', y_true = 'longdash'),
      labels = TeX(c(
        y_pred = '$Y_{pred}$',
        y_pred_fixed = '$Y_{pred}^{(fixed)}$',
        y_true = '$Y_{true}$'
      )),
      drop = TRUE
    ) +
    labs(x = 'Day', y = 'cigarettes consumed') +
    guides(color = guide_legend(nrow = 1)) +
    theme_bw() +
    theme(legend.title = element_blank(),
          legend.position = c(0.50, 0.85),
          legend.background = element_blank())
  
  p_resi <-
    df_pred %>%
    ggplot(aes(x = y_pred, y = y_resi)) +
    geom_hline(yintercept = 0) +
    geom_jitter(alpha = 0.25, width = 0.25, shape = 1) +
    labs(x = TeX('$Y_{pred}$'), y = 'Residual') +
    theme_bw()
  
  y_range <- c(
    min(df_pred$y_true, df_pred$y_pred),
    max(df_pred$y_true, df_pred$y_pred)
  )
  
  p_qq <-
    df_pred %>%
    ggplot(aes(sample = y_resi)) +
    geom_qq(shape = 1) +
    stat_qq_line() +
    labs(x = 'Theoretical normal quantiles',
         y = 'Sample residual quantiles') +
    theme_bw()
  
  cor_fit <- cor.test(df_pred$y_pred, df_pred$y_true)
  if (cor_fit$p.value < 0.001) {
    label_cor <- TeX(sprintf(
      "Pearson's $r = %.3f$ ($p < 0.001$)",
      cor_fit$estimate
    ))
  } else {
    label_cor <- TeX(sprintf(
      "Pearson's $r = %.3f$ ($p = %.3f$)",
      cor_fit$estimate, cor_fit$p.value
    ))
  }
  
  p_pred_true <-
    df_pred %>%
    ggplot(aes(x = y_true, y = y_pred)) +
    geom_abline(slope = 1, intercept = 0) +
    geom_point(alpha = 0.25, shape = 1) +
    geom_smooth(method = 'lm') +
    coord_cartesian(xlim = y_range, ylim = y_range) +
    labs(subtitle = label_cor,
         x = TeX('$Y_{true}$'),
         y = TeX('$Y_{pred}$')) +
    theme_bw()
  
  p_title <-
    ggdraw() + 
    draw_label(
      title,
      fontface = 'bold',
      x = 0,
      hjust = 0
    ) +
    theme(
      # add margin on the left of the drawing canvas,
      # so title is aligned with left edge of first plot
      plot.margin = margin(0, 0, 0, 7)
    )
  
  # plot_grid(
  #   p_title,
  plot_grid(
    p_coef,
    plot_grid(
      p_pred_day,
      # p_resi,
      NULL,
      ncol = 1, align = 'v'
    ),
    nrow = 1
  )
  #   plot_grid(
  #     p_qq,
  #     p_pred_true,
  #     nrow = 1, align = 'hv'
  #   ),
  #   ncol = 1, rel_heights = c(2, 5, 5)
  # )
}
```

```{=html}
<!-- -->
```

```{r fig.width = 8, fig.height = 10, out.width = '0.8\\textwidth'}
# df_daily %>% # all for analysis 1
df_a2_raw %>%  
  # dplyr::select(subject, day_orig) %>%
  # rename(day = day_orig) %>%
  left_join(
    df_exc %>% dplyr::select(subject, is_included),
    by = 'subject'
  ) %>% 
  # group_by(subject) %>% 
  #     mutate(count = row_number()) %>% 
  #     filter(max(count) >=7) %>% ## N=2
  mutate(group = str_c('20', str_sub(subject, 4, 5), '-', str_sub(subject, 6, 6)),
         type = ifelse(is_included, 'inc', 'exc')) %>%
  filter(type == 'inc') %>%
  ggplot(aes(x = day, y = subject)) +
  annotate('rect', xmin = c(0.5, 14.5, 28.5), xmax = c(7.5, 21.5, 35.5),
           ymin = -Inf, ymax = Inf, alpha = 0.15) +
  geom_point(size = 1.5) +
  scale_x_continuous(breaks = seq(1, 43, 7), limits = c(0.5, 45), expand = c(0, 0)) +
  facet_grid(group ~ ., scales = 'free_y', space = 'free_y', switch = 'y') +
  theme_bw() +
  theme(axis.title.y = element_blank(),
        panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank(),
        legend.title = element_blank(),
        strip.text.y.left = element_text(angle = 0),
        strip.placement = 'outside')
```

## Participant demographics
* (Reduced vs. Non-reduced)
```{r}
df_mod_raw <- read_tsv(str_glue(file.path(PATH_DATA, 'analysis_2_data_full_{CRIT_DAYS}days_raw.tsv')))

left_join(
  df_mod_raw %>% 
    dplyr::select(subject, starts_with('daily_avg_cat'), starts_with('usage_reduced_')) %>% # smoked_last_week
    # drop_na() %>%
    gather(session, value, -subject, -starts_with('usage_reduced_')) %>%
    mutate(value = factor(value, levels = c(LABELS_SMOKING_AVG, NA)),
           session = session %>%
             str_remove('daily_avg_cat_') %>%
             factor(levels = c('base', 'pre', 'post'),
                    labels = c('Screening visit', 'Pre-clinic visit', 'Post-clinic visit'))) %>%
    mutate_at(vars(starts_with('usage_reduced_')),
              function(x) factor(x, levels = 0:1, labels = c('Non-reduced', 'Reduced'))) %>%
    arrange(subject, session) %>% 
    dplyr::select(subject, usage_reduced_23) %>% 
    unique(),
  df_mod_raw %>%
    # select(subject, 'sex', all_of(COLS_IV_DEMO), all_of(COLS_DV)),
    dplyr::select(subject, 'sex', all_of(COLS_IV_DEMO), daily_avg_cat_base, daily_avg_cat_pre, daily_avg_cat_post),
  by = "subject") %>% 
  mutate(dur_smoking = replace(dur_smoking, subject == "SMO22209" & is.na(dur_smoking), 2)) %>% 
    left_join(df_chemical %>% 
              dplyr::select(subjID, CO_ppm_scr, CO_ppm_mri1, CO_ppm_mri2) %>% 
              rename('subject' = 'subjID'), 
            by = 'subject') %>% 
  dplyr::select(-subject) %>% 
  # drop_na() %>% 
  rename('Sex' = 'sex',
         'Age' = 'age',
         'Smoking duration' = 'dur_smoking',
         'Daily smoking amount (base)' = 'daily_avg_cat_base',
         'Daily smoking amount (pre)' = 'daily_avg_cat_pre',
         'Daily smoking amount (post)' = 'daily_avg_cat_post',
         'CO level, ppm (base)' = 'CO_ppm_scr', 
         'CO level, ppm (pre)' = 'CO_ppm_mri1', 
         'CO level, ppm (post)' = 'CO_ppm_mri2'
         ) %>% 
  tbl_summary(
    by = usage_reduced_23,
    statistic = list(
      all_continuous() ~ "{mean} ({sd})",
      all_categorical() ~ "{n} ({p}%)"
    ),
    digits = all_continuous() ~ 2,
  ) %>% 
  add_p() %>% 
  bold_labels() %>% 
  as_kable_extra(format = 'latex', booktabs = TRUE, linesep = "",
                 caption = 'Reduced vs. Non-reduced group comparison of demographic factors') %>%
  kable_styling(latex_options = c("striped", "HOLD_position")) %>% 
  pack_rows('Demographics', 1, 5) %>%
  pack_rows('Cigarette usage', 6, 20) 
  
```


* (Didn't smoke on the last week vs. smoked)
-   Criteria: app survey & CO (ppm) < 5
```{r}
df_mod_week <- read_tsv(str_glue(file.path(PATH_DATA, 'analysis_2_data_full_{CRIT_DAYS}days_raw.tsv'))) %>% 
  dplyr::select(subject, sex, starts_with('daily_avg_cat')) %>% 
  left_join(df_quit_crit %>% 
              dplyr::select(subject, did_not_smoke_last_week_co, did_not_smoke_last_month_co), 
            by = 'subject') %>% 
  mutate(sex = case_when(sex == "Male" ~ "1",
                         sex == "Female" ~ "0",
                         TRUE ~as.character(sex)),
          sex = as.numeric(sex)) %>% 
  drop_na()

left_join(
  df_mod_week %>% 
    dplyr::select(subject, starts_with('daily_avg_cat'), starts_with('did_not_smoke_last_')) %>% 
    gather(session, value, -subject, -starts_with('did_not_smoke_last_week')) %>%
    mutate(value = factor(value, levels = c(LABELS_SMOKING_QUIT, NA)),
           session = session %>%
             str_remove('daily_avg_cat_') %>%
             factor(levels = c('base', 'pre', 'post'),
                    labels = c('Screening visit', 'Pre-clinic visit', 'Post-clinic visit'))) %>%
    mutate_at(vars(starts_with('did_not_smoke_last_')),
              function(x) factor(x, levels = 0:1, labels = c('Non-quit', 'Quit'))) %>%
    arrange(subject, session) %>% 
    dplyr::select(subject, did_not_smoke_last_week_co) %>% 
    unique(),
  df_mod_raw %>%
    # select(subject, 'sex', all_of(COLS_IV_DEMO), all_of(COLS_DV)),
    dplyr::select(subject, 'sex', all_of(COLS_IV_DEMO), daily_avg_cat_base, daily_avg_cat_pre, daily_avg_cat_post),
  by = "subject") %>% 
  mutate(dur_smoking = replace(dur_smoking, subject == "SMO22209" & is.na(dur_smoking), 2)) %>% 
    left_join(df_chemical %>% 
              dplyr::select(subjID, CO_ppm_scr, CO_ppm_mri1, CO_ppm_mri2) %>% 
              rename('subject' = 'subjID'), 
            by = 'subject') %>% 
  dplyr::select(-subject) %>% 
  # drop_na() %>% 
  rename('Sex' = 'sex',
         'Age' = 'age',
         'Smoking duration' = 'dur_smoking',
         'Daily smoking amount (base)' = 'daily_avg_cat_base',
         'Daily smoking amount (pre)' = 'daily_avg_cat_pre',
         'Daily smoking amount (post)' = 'daily_avg_cat_post',
         'CO level, ppm (base)' = 'CO_ppm_scr', 
         'CO level, ppm (pre)' = 'CO_ppm_mri1', 
         'CO level, ppm (post)' = 'CO_ppm_mri2'
         ) %>% 
  tbl_summary(
    by = did_not_smoke_last_week_co,
    statistic = list(
      all_continuous() ~ "{mean} ({sd})",
      all_categorical() ~ "{n} ({p}%)"
    ),
    digits = all_continuous() ~ 2,
  ) %>% 
  add_p() %>% 
  bold_labels() %>% 
  as_kable_extra(format = 'latex', booktabs = TRUE, linesep = "",
                 caption = 'Quit vs. Non-quit group (last week) comparison of demographic factors') %>%
  kable_styling(latex_options = c("striped", "HOLD_position")) %>% 
  pack_rows('Demographics', 1, 5) %>%
  pack_rows('Cigarette usage', 6, 20) 
  
```

* (Didn't smoke on the last month vs. smoked)
-   Criteria: app survey & CO (ppm) < 5
```{r}
left_join(
  df_mod_week %>% 
    dplyr::select(subject, starts_with('daily_avg_cat'), starts_with('did_not_smoke_last_')) %>% 
    gather(session, value, -subject, -starts_with('did_not_smoke_last_month')) %>%
    mutate(value = factor(value, levels = c(LABELS_SMOKING_QUIT, NA)),
           session = session %>%
             str_remove('daily_avg_cat_') %>%
             factor(levels = c('base', 'pre', 'post'),
                    labels = c('Screening visit', 'Pre-clinic visit', 'Post-clinic visit'))) %>%
    mutate_at(vars(starts_with('did_not_smoke_last_')),
              function(x) factor(x, levels = 0:1, labels = c('Non-quit', 'Quit'))) %>%
    arrange(subject, session) %>% 
    dplyr::select(subject, did_not_smoke_last_month_co) %>% 
    unique(),
  df_mod_raw %>%
    # select(subject, 'sex', all_of(COLS_IV_DEMO), all_of(COLS_DV)),
    dplyr::select(subject, 'sex', all_of(COLS_IV_DEMO), ftnd, qsu, cds, daily_avg_cat_base, daily_avg_cat_pre, daily_avg_cat_post),
  by = "subject") %>% 
  mutate(dur_smoking = replace(dur_smoking, subject == "SMO22209" & is.na(dur_smoking), 2)) %>% 
    left_join(df_chemical %>% 
              dplyr::select(subjID, CO_ppm_scr, CO_ppm_mri1, CO_ppm_mri2) %>% 
              rename('subject' = 'subjID'), 
            by = 'subject') %>% 
  dplyr::select(-subject) %>% 
  # drop_na() %>% 
  rename('Sex' = 'sex',
         'Age' = 'age',
         'Smoking duration' = 'dur_smoking',
         # 'Daily smoking amount (base)' = 'daily_avg_cat_base',
         # 'Daily smoking amount (pre)' = 'daily_avg_cat_pre',
         # 'Daily smoking amount (post)' = 'daily_avg_cat_post',
         'CO level, ppm (base)' = 'CO_ppm_scr', 
         'CO level, ppm (pre)' = 'CO_ppm_mri1', 
         'CO level, ppm (post)' = 'CO_ppm_mri2'
         ) %>% 
  tbl_summary(
    by = did_not_smoke_last_month_co,
    statistic = list(
      all_continuous() ~ "{mean} ({sd})",
      all_categorical() ~ "{n} ({p}%)"
    ),
    digits = all_continuous() ~ 2,
  ) %>% 
  add_p() %>% 
  bold_labels() %>% 
  as_kable_extra(format = 'latex', booktabs = TRUE, linesep = "",
                 caption = 'Quit vs. Non-quit group (last month) comparison of demographic factors') %>%
  kable_styling(latex_options = c("striped", "HOLD_position")) %>% 
  pack_rows('Demographics', 1, 2) %>%
  pack_rows('Cigarette usage', 3, 17) 
```


```{r}
# beta = beta * (-1)
# Group-level
df_agg %>%
  dplyr::select(subject, day, matches('Q\\d*'), lgQ1p, Q1p,
         alpha_mean, beta_mean, logk_mean) %>%
  rename_at(vars(ends_with('_mean')), function(c) str_remove(c, '_mean')) %>%
  (function(data) {
    inner_join(
      data %>%
        gather(colname, value, -subject, -day, -Q30) %>%
        mutate(colname = str_c(colname, '_curr')) %>%
        spread(colname, value),
      data %>%
        dplyr::select(-c(Q30)) %>% 
        gather(colname, value, -subject, -day) %>%
        mutate(colname = str_c(colname, '_next')) %>%
        spread(colname, value) %>%
        mutate(day = day - 1),
      by = c('subject', 'day')
    )
  }) %>% 
  dplyr::select(subject, day, Q30, ends_with('_curr'),
         matches('(lg)?Q1p?_next')) %>% 
  drop_na(all_of(str_c(c(IV_PARAM, 'Q1'), '_curr')), Q1_next) %>%
  left_join(df_demo, by = 'subject') %>% 
  mutate(day_orig = day) %>%
  mutate(sex = factor(sex, levels = c('Male', 'Female'),
                      labels = c('Male', 'Female'))) %>% 
  rename(Q30_curr = Q30) %>% 
  filter(subject %in% (df_exc %>% filter(is_included) %>% pull(subject))) %>% 
  dplyr::select(subject, day_orig, Q1p_curr, alpha_curr, beta_curr, logk_curr) %>% 
  pivot_longer(cols = c(Q1p_curr, alpha_curr, beta_curr, logk_curr), names_to = "var") %>% 
  ggplot(aes(x = day_orig, y = value, color = var)) + 
  stat_summary(fun.data = mean_se, geom = "point", position = position_dodge(0.9)) + 
  stat_summary(fun.data = mean_se, geom = "linerange", position = position_dodge(0.9)) + 
  stat_summary(fun.data = mean_se, geom = "line", position = position_dodge(0.9)) + 
  scale_color_manual(name = "Variables", 
                     labels = c(TeX('$\\alpha$'),
                                TeX('-$\\beta$'),
                                TeX('log k'),
                                'Daily smoking'),
                     values=c("skyblue", "blue", "darkblue", "red")) + 
  scale_y_continuous(
    "Estimates", 
    sec.axis = sec_axis(~ . * 1.20, name = "Cigarettes per day")
  ) + 
  xlab("Day") + 
  # geom_point(size = 1.5) +
  # scale_x_continuous(breaks = seq(1, 43, 7), limits = c(0.5, 45), expand = c(0, 0)) +
  # facet_grid(group ~ ., scales = 'free_y', space = 'free_y', switch = 'y') +
  theme_bw() +
  theme(panel.grid.minor.x = element_blank(),
        # legend.title = element_blank(),
        # axis.ticks.y.right = element_line(color = "red"),
        axis.ticks.y = element_blank(),
        axis.title.y.left = element_text(color = "blue"),
        axis.text.y.left = element_text(color = "blue"),
        axis.title.y.right = element_text(color = "red"),
        axis.text.y.right = element_text(color = "red"),
        strip.text.y.left = element_text(angle = 0),
        strip.placement = 'outside',
        legend.background = element_rect(colour = 'black', fill = 'white', linetype='solid'),
        legend.position=c(.9, .8))

# Individual-level
df_agg %>%
  dplyr::select(subject, day, matches('Q\\d*'), lgQ1p, Q1p,
         alpha_mean, beta_mean, logk_mean) %>%
  rename_at(vars(ends_with('_mean')), function(c) str_remove(c, '_mean')) %>%
  (function(data) {
    inner_join(
      data %>%
        gather(colname, value, -subject, -day, -Q30) %>%
        mutate(colname = str_c(colname, '_curr')) %>%
        spread(colname, value),
      data %>%
        dplyr::select(-c(Q30)) %>% 
        gather(colname, value, -subject, -day) %>%
        mutate(colname = str_c(colname, '_next')) %>%
        spread(colname, value) %>%
        mutate(day = day - 1),
      by = c('subject', 'day')
    )
  }) %>% 
  dplyr::select(subject, day, Q30, ends_with('_curr'),
         matches('(lg)?Q1p?_next')) %>% 
  drop_na(all_of(str_c(c(IV_PARAM, 'Q1'), '_curr')), Q1_next) %>%
  left_join(df_demo, by = 'subject') %>% 
  mutate(day_orig = day) %>%
  mutate(sex = factor(sex, levels = c('Male', 'Female'),
                      labels = c('Male', 'Female'))) %>% 
  rename(Q30_curr = Q30) %>% 
  filter(subject %in% (df_exc %>% filter(is_included) %>% pull(subject))) %>% 
  dplyr::select(subject, day_orig, Q1p_curr, alpha_curr, beta_curr, logk_curr) %>% 
  pivot_longer(cols = c(Q1p_curr, alpha_curr, beta_curr, logk_curr), names_to = "var") %>% 
  ggplot(aes(x = day_orig, y = value, color = var)) + 
  geom_point(aes(alpha = 0.4)) + 
  # stat_summary(fun.data = mean_se, geom = "point", position = position_dodge(0.9)) + 
  # stat_summary(fun.data = mean_se, geom = "linerange", position = position_dodge(0.9)) + 
  # stat_summary(fun.data = mean_se, geom = "line", position = position_dodge(0.9)) + 
  scale_color_manual(name = "Variables", 
                     labels = c(TeX('$\\alpha$'),
                                TeX('-$\\beta$'),
                                TeX('log k'),
                                'Daily smoking'),
                     values=c("skyblue", "blue", "darkblue", "red")) + 
  scale_y_continuous(
    "Estimates", 
    sec.axis = sec_axis(~ . * 1.20, name = "Cigarettes per day")
  ) + 
  xlab("Day") + 
  # geom_point(size = 1.5) +
  # scale_x_continuous(breaks = seq(1, 43, 7), limits = c(0.5, 45), expand = c(0, 0)) +
  # facet_grid(group ~ ., scales = 'free_y', space = 'free_y', switch = 'y') +
  theme_bw() +
  theme(panel.grid.minor.x = element_blank(),
        # legend.title = element_blank(),
        # axis.ticks.y.right = element_line(color = "red"),
        axis.ticks.y = element_blank(),
        axis.title.y.right = element_text(color = "red"),
        axis.text.y.right = element_text(color = "red"),
        strip.text.y.left = element_text(angle = 0),
        strip.placement = 'outside',
        legend.background = element_rect(colour = 'black', fill = 'white', linetype='solid'),
        legend.position=c(.9, .87))

```

```{r}
df_demo %>%
  filter(subject %in% (df_exc %>% filter(is_included) %>% pull(subject))) %>%
  dplyr::select(sex, age) %>%
  tbl_summary(
    statistic = list(
      all_continuous() ~ "{mean} ({sd}; {min}, {max})"
    )
  ) %>%
  as_kable_extra(format = 'latex', booktabs = TRUE)
```

```{r}
p_coef <-
  df_coef %>%
    ggplot(aes(x = term, y = estimate, color = is_sig)) +
    geom_hline(yintercept = 0, colour = "grey60", linetype = 2) +
    geom_errorbar(aes(ymin = ci_lower, ymax = ci_upper), width = 0) +
    geom_point(size = 3) +
    labs(y = "Beta estimate", 
         # title = title, 
         subtitle = subtitle) +
    scale_color_manual(values = c("1" = "red", "0" = "#666666", "-1" = "blue")) +
    scale_x_discrete(labels = TeX(as.character(df_coef$term))) +
    coord_flip() +
    theme_bw() +
    theme(legend.position = "none",
          axis.title.y = element_blank(),
          axis.text.y = element_text(size = 11, hjust = 1, color = 'black'),
          plot.title = element_text(face = "bold", hjust = 0.5),
          plot.subtitle = element_text(hjust = 0.5))  
```


```{r, fig.width = 8, fig.height = 3.5}
plot_grid(
  df_agg %>%
    filter(subject %in% (df_exc %>% filter(is_included) %>% pull(subject))) %>%
    dplyr::select(day, Q1) %>%
    drop_na() %>%
    group_by(day) %>%
    summarize(m = mean(Q1, na.rm = TRUE),
              std = sd(Q1, na.rm = TRUE),
              se = sd(Q1, na.rm = TRUE) / sqrt(n() - 1)) %>%
    ggplot(aes(x = day, y = m)) +
    annotate('rect', xmin = c(0.5, 14.5, 28.5), xmax = c(7.5, 21.5, 35.5),
             ymin = -Inf, ymax = Inf, alpha = 0.15) +
    geom_hline(yintercept = 0) +
    # geom_ribbon(aes(ymin = m - 1.96 * se, ymax = m + 1.96 * se),
    #             fill = '#999999', alpha = 0.5) +
    # geom_errorbar(aes(ymin = m - 1.96 * se, ymax = m + 1.96 * se),
    #               width = 0, alpha = 0.5) +
    geom_errorbar(aes(ymin = m - std, ymax = m + std),
                  width = 0, alpha = 0.5) +
    geom_point() +
    geom_line() +
    scale_x_continuous(breaks = seq(1, 43, 7), limits = c(0.5, 43.5), expand = c(0, 0)) +
    # scale_y_continuous(expand = expansion(mult = c(0, 0.05))) +
    labs(x = 'Day', y = 'Cigarette usage',
         caption = TeX('* Errorbars indicate the ranges of mean $\\pm$ 1 SD for each day.')) +
    # coord_cartesian(ylim = c(0, NA)) +
    theme_bw() +
    theme(panel.grid.major.x = element_blank(),
          panel.grid.minor.x = element_blank()),
  df_agg %>%
    filter(subject %in% (df_exc %>% filter(is_included) %>% pull(subject))) %>%
    ggplot(aes(x = Q1)) +
    geom_bar(stat = "count", fill = "#999999") +
    geom_line(stat = "count") +
    geom_point(stat = "count") +
    scale_y_continuous(expand = expansion(mult = c(0, 0.05))) +
    labs(x = "Cigarette usage", y = "Frequency") +
    theme_bw(),
  nrow = 1, align = 'hv'
)
```

\pagebreak

# Model comparison

```{r setup_cv}
CV_K <- 3
CV_REP <- 100
```

```{r functions_cv}
run_model_with_loocv <- function(data, config) {
  fml <- make_formula(config$dv, config$ivs_fixed, config$ivs_random)
  
  # Make a dataset to use
  data_all <-
    data %>%
    dplyr::select(all_of(c(config$dv, config$ivs_fixed, config$ivs_random)), day_orig) %>%
    drop_na()
  
  is_glm <- (config$model_name %in% c('GLM', 'GLMM'))
  model_func <- switch(
    config$model_name, LM = lm, GLM = glm, LMM = lmer, GLMM = glmer)
  
  # Fit a model with the whole dataset
  if (!is_glm) {
    mod_all <- model_func(formula = fml, data = data_all)
  } else {
    mod_all <- model_func(formula = fml, data = data_all, family = config$model_family)
  }
  
  # Run leave-one-out cross-validation (LOOCV)
  folds <- create_folds(data %>% pull(subject), type = 'stratified',
                        k = CV_K, m_rep = CV_REP)
  fit_r2_train <- c()
  fit_r2_test <- c()
  fit_mse_train <- c()
  fit_mse_test <- c()
  
  for (fold in folds) {
    data_train <- data_all[fold,]
    data_test  <- data_all[-fold,]
    
    if (!is_glm) {
      mod <- model_func(formula = fml, data = data_train)
    } else {
      mod <- model_func(formula = fml, data = data_train, family = config$model_family)
    }
    
    y_true_train <- data_train %>% pull(all_of(config$dv))
    y_pred_train <- predict(mod, newdata = data_train, type = 'response') %>% as.vector %>% unname
    y_true_test <- data_test %>% pull(all_of(config$dv))
    y_pred_test <- predict(mod, newdata = data_test, type = 'response') %>% as.vector %>% unname
    
    fit_r2_train <- c(fit_r2_train, calculate_r2(y_true_train, y_pred_train))
    fit_r2_test <- c(fit_r2_test, calculate_r2(y_true_test, y_pred_test))
    fit_mse_train <- c(fit_mse_train, calculate_mse(y_true_train, y_pred_train))
    fit_mse_test <- c(fit_mse_test, calculate_mse(y_true_test, y_pred_test))
  }
  
  list(
    data = data_all,
    config = config,
    fml = fml,
    mod = mod_all,
    cv = list(
      r2_train = fit_r2_train, r2_test = fit_r2_test,
      mse_train = fit_mse_train, mse_test = fit_mse_test
    )
  )
}
```

```{r configs}
configs_mod <- list(
  # list(
  #   model_family = gaussian(),
  #   model_name = 'LM'
  # ),
  # list(
  #   model_family = gaussian(link = 'log'),
  #   model_name = 'GLM',
  #   model_desc = '(Gaussian, log link)'
  # ),
  list(
    model_family = gaussian(),
    model_name = 'LMM'
  ),
  # list(
  #   model_family = gaussian(link = 'log'),
  #   model_name = 'GLMM',
  #   model_desc = '(Gaussian, log link)'
  # ),
  NULL
)

configs_ivs_fixed <- list(
  list(ivs_fixed = c()),
  list(ivs_fixed = c(str_c(IV_PARAM[1], '_curr'))),
  list(ivs_fixed = c(str_c(IV_PARAM[1], '_curr'), 'day')),
  list(ivs_fixed = c(str_c(IV_PARAM[2], '_curr'))),
  list(ivs_fixed = c(str_c(IV_PARAM[2], '_curr'), 'day')),
  list(ivs_fixed = c(str_c(IV_PARAM[3], '_curr'))),
  list(ivs_fixed = c(str_c(IV_PARAM[3], '_curr'), 'day')),
  list(ivs_fixed = c(str_c(IV_PARAM, '_curr'))),
  list(ivs_fixed = c(str_c(IV_PARAM, '_curr'), 'day')),
  list(ivs_fixed = c(str_c(IV_SURVEY[1], '_curr'))),
  list(ivs_fixed = c(str_c(IV_SURVEY[1], '_curr'), 'day')),
  list(ivs_fixed = c(str_c(c(IV_SURVEY[1], IV_PARAM[1]), '_curr'))),
  list(ivs_fixed = c(str_c(c(IV_SURVEY[1], IV_PARAM[1]), '_curr'), 'day')),
  list(ivs_fixed = c(str_c(c(IV_SURVEY[1], IV_PARAM[2]), '_curr'))),
  list(ivs_fixed = c(str_c(c(IV_SURVEY[1], IV_PARAM[2]), '_curr'), 'day')),
  list(ivs_fixed = c(str_c(c(IV_SURVEY[1], IV_PARAM[3]), '_curr'))),
  list(ivs_fixed = c(str_c(c(IV_SURVEY[1], IV_PARAM[3]), '_curr'), 'day')),
  list(ivs_fixed = c(str_c(IV_SURVEY[1:2], '_curr'))),
  list(ivs_fixed = c(str_c(IV_SURVEY[1:2], '_curr'), 'day')),
  list(ivs_fixed = c(str_c(c(IV_SURVEY[1:2], IV_PARAM), '_curr'))),
  list(ivs_fixed = c(str_c(c(IV_SURVEY[1:2], IV_PARAM), '_curr'), 'day')),
  list(ivs_fixed = c(str_c(IV_SURVEY, '_curr'))),
  list(ivs_fixed = c(str_c(IV_SURVEY[1:6], '_curr'))),
  list(ivs_fixed = c(str_c(IV_SURVEY[1:6], '_curr'), 'day')),
  list(ivs_fixed = c(str_c(IV_SURVEY, '_curr'), 'day')),
  list(ivs_fixed = c(str_c(c(IV_SURVEY[1:6], IV_PARAM), '_curr'))),
  list(ivs_fixed = c(str_c(c(IV_SURVEY, IV_PARAM), '_curr'))),
  list(ivs_fixed = c(str_c(c(IV_SURVEY[1:6], IV_PARAM), '_curr'), 'day')),
  list(ivs_fixed = c(str_c(c(IV_SURVEY, IV_PARAM), '_curr'), 'day'))
)

configs_ivs_random <- list(
  list(ivs_random = c()),
  list(ivs_random = c('subject'))
)

CONFIGS <-
  lapply(configs_mod, function(c_m) {
    if (is.null(c_m)) {
      return(NULL)
    }
    
    lapply(configs_ivs_random, function(c_ir) {
      is_lmm <- c_m$model_name %in% c('LMM', 'GLMM')
      has_rand_eff <- any(!is.null(c_ir$ivs_random))
      
      if (xor(is_lmm, has_rand_eff)) {
        return(NULL)
      } 
      
      lapply(configs_ivs_fixed, function(c_if) {
        c(
          list(
            dv = str_c(IV_SURVEY[1], '_next'),
            exclude_outliers = FALSE
          ),
          c_m,
          c_if,
          c_ir
        )
      })
    }) %>%
      do.call(what = c)
  }) %>%
  do.call(what = c) %>%
  (function(lc) {
    lc[sapply(lc, function(x) !is.null(x))]
  })
```

```{r run_cv}
fn_cache <- './cache/cvfits_time-lagged_with_med.RData'

if (!file.exists(fn_cache) || TRUE) {
  df_cv <- NULL
  cvfits <- list()
  
  for (i in 1:length(CONFIGS)) {
    config <- CONFIGS[[i]]
    cvfits[[i]] <- run_model_with_loocv(df_daily, config)
    
    df_cv <- bind_rows(
      df_cv,
      tibble(
        idx = i,
        model_name = config$model_name,
        model_desc = ifelse(is.null(config$model_desc), '', config$model_desc),
        dv = config$dv,
        ivs_fixed = paste(get_label_for_term(config$ivs_fixed), collapse = ', '),
        ivs_random = paste(get_label_for_term(config$ivs_random), collapse = ', '),
        r2_train = mean(cvfits[[i]]$cv$r2_train),
        mse_train = mean(cvfits[[i]]$cv$mse_train),
        r2_test = mean(cvfits[[i]]$cv$r2_test),
        mse_test = mean(cvfits[[i]]$cv$mse_test)
      )
    )
  }
  save(cvfits, df_cv, file = fn_cache)
  # system(sprintf("slackbot -d '@jeunghyunlee' -m 'Appdata LMM CV, prediction complete'"))
} else {
  load(fn_cache)
}

```

```{r}

cvfit_best <- cvfits[[idx_best]]
config_best <- cvfit_best$config
mod <- cvfit_best$mod
smr <- summary(mod)

smr$coefficient %>%
    as.data.frame() %>%
    rownames_to_column('variable') %>%
    dplyr::select(variable, Estimate) %>%
    mutate(variable = factor(variable, levels = custom_order)) %>%
    arrange(variable) %>% 
    column_to_rownames('variable')


best_model <- lmer(Q1_next ~  alpha_curr + beta_curr + logk_curr + Q1_curr + Q2_curr + Q3_curr + Q6_curr + Q7_curr + Q8_curr + Q30_curr + day + (1 | subject), data = df_daily)
sum_best_model <- summary(best_model)
MuMIn::r.squaredGLMM(best_model)
r2 <- get_r2_marg_cond(best_model)
subtitle <-
  sprintf("$R^2_{fixed}$ = $%.3f$, $R^2_{total}$ = $%.3f$",
          r2$marg, r2$cond) %>%
  TeX()

df_coef <-
  sum_best_model$coefficients %>%
    as.data.frame() %>%
    rownames_to_column('term') %>%
    as_tibble() %>%
    rename(estimate = Estimate,
           std.error = `Std. Error`) %>%
    rename_at(vars(starts_with('Pr(>')), function(v) 'p.value') %>%
    filter(term != '(Intercept)') %>%
    mutate(
      term = factor(
        term,
        levels = term %>% rev, 
        labels = get_label_for_term(term) %>% rev
      ),
      ci_lower = estimate - 1.96 * std.error,
      ci_upper = estimate + 1.96 * std.error,
      is_sig = ifelse(ci_lower > 0, 1, ifelse(ci_upper < 0, -1, 0)),
      is_sig = as.character(is_sig)
    )
  
p_coef <-
  df_coef %>%
    ggplot(aes(x = term, y = estimate, color = is_sig)) +
    geom_hline(yintercept = 0, colour = "grey60", linetype = 2) +
    geom_errorbar(aes(ymin = ci_lower, ymax = ci_upper), width = 0) +
    geom_point(size = 3) +
    labs(y = "Beta estimate", 
         # title = title, 
         subtitle = subtitle) +
    scale_color_manual(values = c("1" = "red", "0" = "#666666", "-1" = "blue")) +
    scale_x_discrete(labels = TeX(as.character(df_coef$term))) +
    coord_flip() +
    theme_bw() +
    theme(legend.position = "none",
          axis.title.y = element_blank(),
          axis.text.y = element_text(size = 11, hjust = 1, color = 'black'),
          plot.title = element_text(face = "bold", hjust = 0.5),
          plot.subtitle = element_text(hjust = 0.5))


```


```{r}
# regressing out usage variable 
# autocorrelation analysis
# step 1: Regress usage on t+1 on t
model1 <- lm(Q1p_next ~ Q1_curr, data = df_daily)
df_daily$residuals <- residuals(model1)

# step 2: Use residuals in the mixed-effect model
# Q2: craving
# Q3: mood
# Q6: stress
# Q7: depression
# Q8: anxiety
# Q30: medication 
model2 <- lmer(residuals ~  alpha_curr + beta_curr + logk_curr + Q2_curr + Q3_curr + Q6_curr + Q7_curr + Q8_curr + Q30_curr + day + (1 | subject), data = df_daily)
sum_model2 <- summary(model2)
MuMIn::r.squaredGLMM(model2)
r2 <- get_r2_marg_cond(model2)
subtitle <-
  sprintf("$R^2_{fixed}$ = $%.3f$, $R^2_{total}$ = $%.3f$",
          r2$marg, r2$cond) %>%
  TeX()

df_coef <-
  sum_model2$coefficients %>%
    as.data.frame() %>%
    rownames_to_column('term') %>%
    as_tibble() %>%
    rename(estimate = Estimate,
           std.error = `Std. Error`) %>%
    rename_at(vars(starts_with('Pr(>')), function(v) 'p.value') %>%
    filter(term != '(Intercept)') %>%
    mutate(
      term = factor(
        term,
        levels = term %>% rev, 
        labels = get_label_for_term(term) %>% rev
      ),
      ci_lower = estimate - 1.96 * std.error,
      ci_upper = estimate + 1.96 * std.error,
      is_sig = ifelse(ci_lower > 0, 1, ifelse(ci_upper < 0, -1, 0)),
      is_sig = as.character(is_sig)
    )
  
p_coef <-
  df_coef %>%
    ggplot(aes(x = term, y = estimate, color = is_sig)) +
    geom_hline(yintercept = 0, colour = "grey60", linetype = 2) +
    geom_errorbar(aes(ymin = ci_lower, ymax = ci_upper), width = 0) +
    geom_point(size = 3) +
    labs(y = "Beta estimate", 
         # title = title, 
         subtitle = subtitle) +
    scale_color_manual(values = c("1" = "red", "0" = "#666666", "-1" = "blue")) +
    scale_x_discrete(labels = TeX(as.character(df_coef$term))) +
    coord_flip() +
    theme_bw() +
    theme(legend.position = "none",
          axis.title.y = element_blank(),
          axis.text.y = element_text(size = 11, hjust = 1, color = 'black'),
          plot.title = element_text(face = "bold", hjust = 0.5),
          plot.subtitle = element_text(hjust = 0.5))



```


```{r}
idx_best <- df_cv %>% filter(mse_test == min(mse_test)) %>% pull(idx)

df_cv %>%
  mutate(d_mse_train = mse_train - min(mse_train),
         d_mse_test = mse_test - min(mse_test)) %>%
  dplyr::select(idx, ivs_fixed,
         r2_train, mse_train, d_mse_train,
         r2_test, mse_test, d_mse_test) %>%
  kable(format = 'latex', booktabs = TRUE, digits = 3, escape = FALSE, linesep = '', 
        col.names = c(
          "\\#", "IV$_\\text{fixed}$",
          "$R^2$", "MSE", "$\\Delta$MSE",
          "$R^2$", "MSE", "$\\Delta$MSE"
        ),
        caption = str_glue("Model comparison results of {CV_K}-fold cross validation with {CV_REP} repetitions.")) %>%
  kable_styling(font_size = 10, latex_options = c('HOLD_position')) %>%
  add_header_above(c(" " = 2, "Train" = 3, "Test" = 3)) %>%
  row_spec(idx_best, background = 'yellow') %>%
  footnote(
    general = str_c(
      "All models included subject as a random effect."
    )
  ) %>%
  landscape()


# for html display
df_cv %>%
  mutate(d_mse_train = mse_train - min(mse_train),
         d_mse_test = mse_test - min(mse_test)) %>%
  dplyr::select(idx, ivs_fixed,
         r2_train, mse_train, d_mse_train,
         r2_test, mse_test, d_mse_test) %>%
  kable(format = 'html', digits = 3, escape = FALSE, 
        col.names = c(
          "#", "IV_fixed",
          "R² (Train)", "MSE (Train)", "ΔMSE (Train)",
          "R² (Test)", "MSE (Test)", "ΔMSE (Test)"
        ),
        caption = str_glue("Model comparison results of {CV_K}-fold cross validation with {CV_REP} repetitions.")) %>%
  kable_styling(font_size = 10, full_width = FALSE) %>%
  add_header_above(c(" " = 2, "Train" = 3, "Test" = 3)) %>%
  row_spec(idx_best, background = '#FFFFA7') %>%
  footnote(
    general = "All models included subject as a random effect."
  ) 

```

## Best model
# this is the coefficient plot 

```{r, fig.width = 8, fig.height = 4, out.width = '.8\\textwidth'}
cvfit_best <- cvfits[[idx_best]]
config_best <- cvfit_best$config

draw_figure(
  cvfit_best$data,
  config_best,
  cvfit_best$mod,
  config_best$dv,
  sprintf(
    'Model %d: %s %s\n%s',
    idx_best, config_best$model_name,
    ifelse(!is.null(config_best$model_desc), str_c('- ', config_best$model_desc), ''),
    paste(format(cvfit_best$fml), collapse = '\n')
  )
)


```

## Full model

```{r, fig.width = 8, fig.height = 4, out.width = '.8\\textwidth'}
idx_full <- length(cvfits)
cvfit_full <- cvfits[[idx_full]]
config_full <- cvfit_full$config

draw_figure(
  cvfit_full$data,
  config_full,
  cvfit_full$mod,
  config_full$dv,
  sprintf(
    'Model %d: %s %s\n%s',
    idx_full, config_full$model_name,
    ifelse(!is.null(config_full$model_desc), str_c('- ', config_full$model_desc), ''),
    paste(format(cvfit_full$fml), collapse = '\n')
  )
)
ggsave('figures/fig_time-lagged_full.pdf', width = 8, height = 4, dpi = 300)

```

```{r}
# 
df_daily %>%
  group_by(day_orig) %>%
  # summarise(correlation = cor(Q2_curr, logk_curr)) %>%
  summarise(correlation = cor(Q2_curr, logk_curr),
            p_value = cor.test(Q2_curr, logk_curr, use = "pairwise.complete.obs")$p.value,
            n = sum(!is.na(Q2_curr) & !is.na(logk_curr))) %>% 
  ggplot(aes(x = day_orig, y = correlation)) +
  geom_point(alpha = 0.5) +
  geom_text(
    aes(label = ifelse(p_value < 0.05, "*", "")),  # Add asterisk if p_value < 0.05
    vjust = 0.1, size = 6, color = "red"
  ) + 
  geom_hline(yintercept = 0, linetype = "dashed", color = "grey") + 
  # geom_smooth(method = "lm", se = FALSE, color = "navy") +  # Add trend line
  labs(title = "Correlation between Q2_curr and logk_curr by Day",
       x = "day", y = "corr") +
  theme_bw()

df_daily %>% 
  group_by(day)
  ggplot(aes(x = Q2_curr, y = logk_curr)) +
  geom_point(alpha = 0.5) +
  facet_wrap(~ day) +
  geom_smooth(method = "lm", se = FALSE, color = "blue") +  # Add trend line
  labs(title = "Correlation between Q2_curr and logk_curr by Day",
       x = "Q2_curr", y = "logk_curr") +
  theme_bw()

# day by day craving & logk
df_daily %>% 
  ggplot(aes(x = Q2_curr, y = logk_curr)) + 
  geom_point() + 
  coord_cartesian(xlim = c(-3, 3), ylim = c(-3, 3))

df_numeric <- df_daily %>%
  select(Q2_curr, logk_curr) %>%
  na.omit() 

cor_results <- Hmisc::rcorr(as.matrix(df_numeric))
cor_matrix <- cor_results$r
p_matrix <- cor_results$P

ggcorrplot(cor_matrix,
           method = "circle",
           lab = TRUE,  # Show correlation coefficients
           p.mat = p_matrix,  # Add p-values for significance
           sig.level = 0.05,  # Only display significant correlations
           insig = "blank",  # Hide insignificant correlations
           type = "lower") +
  labs(title = "Correlation Matrix with p-values",
       subtitle = "Significant correlations (p < 0.05)",
       caption = "Data includes selected variables") +
  theme_minimal()

correlation_data <- df_daily %>%
  select(Q2_curr, alpha_curr, beta_curr, logk_curr)  # Select relevant variables
correlation_matrix <- cor(correlation_data, use = "complete.obs")  # Compute correlation matrix

# Convert correlation matrix to tidy format
as.table(correlation_matrix) %>%
  as.data.frame() %>% 
  rename(Var1 = Var1, Var2 = Var2, Correlation = Freq) %>% 
  ggplot(aes(x = Var1, y = Var2, fill = Correlation)) +
  geom_tile(color = "white") +
  scale_fill_gradient2(low = "blue", high = "red", mid = "white",
                       midpoint = 0, limit = c(-1, 1), space = "Lab",
                       name = "Correlation") +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1),
    panel.grid = element_blank()
  ) +
  labs(title = "Correlation Matrix",
       x = NULL,
       y = NULL)
```


